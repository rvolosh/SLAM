---
title: "test SLAM functions"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{test}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

```{r setup}
library(SLAM)
library(dplyr)
```

## Test merge_diftime


```{r}
# Example Merging clostest NMR to Glucose --------------------------------------

# Checkout data --------------------------------------------------------------
# Checkout census
head(data_SLAM_census)

# Checkout glucose
head(data_SLAM_gluc)

# Checkout nmr
head(data_SLAM_nmr)

# Create gluc ----------------------------------------------------------------
# join glucose and census for dob and other infor
gluc <- dplyr::left_join(data_SLAM_gluc, data_SLAM_census, by = "idno")
# drop useless vars
gluc <- dplyr::select(gluc, -c(lact, cohort, animal_id, tag, taghistory, cage, eartag, name, X))
# create age for merging and format data so it makes sense
gluc <- dplyr::mutate(gluc,
                      age_wk = difftime(date, dob, units = "weeks"),
                      date = as.Date(date, "%m%d%Y")
)

# Create nmr -----------------------------------------------------------------
# join nmr with census for dob and other info
nmr <- dplyr::left_join(data_SLAM_nmr, data_SLAM_census, by = "idno")
# drop useless columns
nmr <- dplyr::select(nmr, -c(cohort, animal_id, tag, taghistory, cage, eartag, name, X))
# create age for merging and format data so it makes sense
nmr <- dplyr::mutate(nmr,
                     age_wk = difftime(date, dob, units = "weeks"),
                     date = as.Date(date, "%m%d%Y")
)

# Use merge_diftime ----------------------------------------------------------
gluc_nmr <- merge_diftime(
  data1 = gluc,
  data2 = nmr,
  id = "idno",
  age = "age_wk",
  vars = c("bw", "lean", "fluid", "fat"),
  clean_vars = FALSE)

# Checkout results
head(gluc_nmr)

```

## Test add_delta

```{r add_delta}
# test ---------------------------------
data <- data_SLAM_nmr %>%
  dplyr::left_join(data_SLAM_census, by = "idno") 

data <- data[data$cohort %in% c(1,2,3,4,5,6), ]
cols <- c("bw","fat")
id <- "idno"
type <- "lag"
fill <- 0
n <- 1L
time <- "date"
prefix <- paste("delta", type, n, sep = "_")

add_delta <-function(data, cols, id, time, fill = 0, n = 1L, type = "lag", prefix = paste("delta", type, n, sep = "_")){
  
  # convert fill to numeric
  fill <- as.numeric(fill)
  # convert data to datatable
  dt <- data.table::data.table(data)

  # loop through cols ----------------------------------------------------------
  for(col in cols){
    # calculate deltas for variable defined by col -----------------------------
    # delta variable name
    col_delta <- paste(prefix, col, sep = "_")
    # na varialbe name
    col_na <- paste(col, "na", sep = "_")
    
    # data table chain ---------------------------------------------------------
    # create col_na that is true if col is NA and false otherwise
    dt <- dt[, (col_na) := lapply(.SD, is.na), .SDcols = col 
    # order dt by time so that rolling differences are taken properly
                  ][order(dt[[time]])
    # create delta variable using n and type arguments specified in function call.
    # the dt is grouped by id and col_na so that delta calculation will "skip"
    # dates when there is NAs
                    ][, (col_delta) := .SD - data.table::shift(x = .SD, n = n, fill = NA, type = type), keyby = c(id, col_na), .SDcols = col]
    # if there are NA's in col_delta and no NAs in col, we know that the NA
    # in col_delta is from lag window. We want to replace these NA's. However,
    # any NA's in col_delta from due to an NA in col, we want to leave these NA.
    dt <- dt[is.na(dt[[col_delta]]) & !dt[[col_na]], (col_delta) := (fill)]
                      
  }
  # ----------------------------------------------------------------------------

  # reorder by id and time because currently order by time, id, and col_na
  dt <- data.table::setorderv(x = dt, col = c(id, time))
  # convert data.table to dataframe
  data <-as.data.frame(dt)
  
  #return data
  data
}

data <- add_delta(data = data, cols = cols, id = id, time = time, fill = 0)
```



